<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.1.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.1.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.1.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.1.0',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="摘要随着App业务的发展，业务模块会越来越多，而不同模块可能对某一个功能都有依赖，比如分享、登录等，这个时候如果没有将这些通用的功能抽象成组件单独拎出来，就面临着相同功能的代码在不同的模块中都有一分实现，如果需要更改这个功能的实现，就需要在每个模块中都改一遍，因此需要将这些通用功能抽象成组件独立出来，这就是组件化的过程。">
<meta name="keywords" content="Android">
<meta property="og:type" content="article">
<meta property="og:title" content="Android组件化开发实践">
<meta property="og:url" content="http://yoursite.com/posts/A191027.html">
<meta property="og:site_name" content="荏苒追寻个人博客">
<meta property="og:description" content="摘要随着App业务的发展，业务模块会越来越多，而不同模块可能对某一个功能都有依赖，比如分享、登录等，这个时候如果没有将这些通用的功能抽象成组件单独拎出来，就面临着相同功能的代码在不同的模块中都有一分实现，如果需要更改这个功能的实现，就需要在每个模块中都改一遍，因此需要将这些通用功能抽象成组件独立出来，这就是组件化的过程。">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-03-25T05:26:43.796Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android组件化开发实践">
<meta name="twitter:description" content="摘要随着App业务的发展，业务模块会越来越多，而不同模块可能对某一个功能都有依赖，比如分享、登录等，这个时候如果没有将这些通用的功能抽象成组件单独拎出来，就面临着相同功能的代码在不同的模块中都有一分实现，如果需要更改这个功能的实现，就需要在每个模块中都改一遍，因此需要将这些通用功能抽象成组件独立出来，这就是组件化的过程。">






  <link rel="canonical" href="http://yoursite.com/posts/A191027.html">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Android组件化开发实践 | 荏苒追寻个人博客</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> 

<div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">荏苒追寻个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">做一个有追求的青年</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
          
  <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-schedule">
    <a href="/schedule/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-calendar"></i> <br>日程表</a>
</li>

      

      
    </ul>
  

  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/posts/A191027.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Randy Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="荏苒追寻个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Android组件化开发实践</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-27T00:00:00+08:00">2019-10-27</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>随着App业务的发展，业务模块会越来越多，而不同模块可能对某一个功能都有依赖，比如分享、登录等，这个时候如果没有将这些通用的功能抽象成组件单独拎出来，就面临着相同功能的代码在不同的模块中都有一分实现，如果需要更改这个功能的实现，就需要在每个模块中都改一遍，因此需要将这些通用功能抽象成组件独立出来，这就是组件化的过程。</p>
<a id="more"></a>
<h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p>切换到项目根目录，使用<code>tree -d -L 1</code>命令查看项目的结构。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── app                 # 壳子App</span><br><span class="line">├── common              # 通用库，包括基础工具类、网络请求等的封装</span><br><span class="line">├── common-res          # 通用资源库，包括一些通用的图片、颜色等资源</span><br><span class="line">├── component-app       # app module    (以module形式存在的组件)</span><br><span class="line">├── component-image     # image module  (以module形式存在的组件)</span><br><span class="line">├── component-movie     # movie module  (以module形式存在的组件)</span><br><span class="line">├── component-music     # music module  (以module形式存在的组件)</span><br><span class="line">├── component-read      # read module   (以module形式存在的组件)</span><br><span class="line">├── component-video     # video module  (以module形式存在的组件)</span><br><span class="line">├── magicindicator      # 引入的一个第三方控件</span><br><span class="line">└── router              # 路由module     (主要职责：负责解决不同module（组件）之间的通信)</span><br></pre></td></tr></table></figure></p>
<h2 id="要解决的问题"><a href="#要解决的问题" class="headerlink" title="要解决的问题"></a>要解决的问题</h2><p>组件化的过程中通常会遇到以下这些问题：</p>
<ol>
<li>组件单独调试，即在没有集成到APP壳子工程上去之前，我们可以单独编译、运行、调试对应组件；</li>
<li>组件通信，这里说的通信，指的是APP壳子工程和组件、组件与组件之间的通信，包括页面访问、数据传递；</li>
<li>组件集成，在各个组件开发好后，如何方便的集成到APP壳子中去；</li>
<li>组件容错，集成是在某个被集成的组件没有开发好的情况下如何友好的容错；</li>
<li>组件解耦与代码隔离，这里的接口要求组件A中不直接出现组件B中的某个类的引用</li>
</ol>
<h3 id="组件单独调试"><a href="#组件单独调试" class="headerlink" title="组件单独调试"></a>组件单独调试</h3><p>Android Studio采用的是Gradle来构建项目的，对于一个module，可以对其应用以下插件：</p>
<ul>
<li>APP插件，对应插件id为<code>com.android.application</code>，用来配置一个Android App工程，构建后输出一个apk安装包；</li>
<li>Library插件，对应插件id为<code>com.android.library</code>，用来构建一个Android Library工程，构建后输出一个aar包；</li>
<li>Test插件，对应插件id为<code>com.android.test</code>，用来构建一个Android Test工程；</li>
</ul>
<p>显然，单独调试时就要采用APP插件，被别的module依赖时就要采用Library插件，所以只要动态的设置插件id就可以了，而动态配置这个插件id对于gradle来说是超简单的。项目根目录下新建一个base_component.gradle文件，加入如下内容：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基本组件的配置信息</span></span><br><span class="line"><span class="comment">// 获取组件名，新建组件module时，请按”component-组件名“格式命名，方便这里处理</span></span><br><span class="line"><span class="keyword">def</span> componentName = project.getName().replaceAll(<span class="string">"component-"</span>, <span class="string">""</span>)</span><br><span class="line"><span class="comment">// 是否独立运行，这里的merge为根目录下config.gradle文件中定义的一个数组，表示在编译的时候要被集成的component，</span></span><br><span class="line"><span class="comment">// 根据是否包含着该数组中来判断当前module是作为库项目还是独立运行项目</span></span><br><span class="line"><span class="keyword">def</span> isRunAlone = !rootProject.ext.merge.contains(componentName)</span><br><span class="line"><span class="keyword">if</span> (isRunAlone) &#123;</span><br><span class="line">    apply <span class="string">plugin:</span> <span class="string">"com.android.application"</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    apply <span class="string">plugin:</span> <span class="string">"com.android.library"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">def</span> javaVersion = JavaVersion.VERSION_1_8</span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.jakewharton.butterknife'</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.alibaba.arouter'</span></span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion rootProject.ext.android.compileSdkVersion</span><br><span class="line">    buildToolsVersion rootProject.ext.android.buildToolsVersion</span><br><span class="line"></span><br><span class="line">    compileOptions &#123;</span><br><span class="line">        sourceCompatibility javaVersion</span><br><span class="line">        targetCompatibility javaVersion</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        minSdkVersion rootProject.ext.android.minSdkVersion</span><br><span class="line">        targetSdkVersion rootProject.ext.android.targetSdkVersion</span><br><span class="line">        <span class="keyword">if</span> (isRunAlone) &#123;</span><br><span class="line">            <span class="comment">// 单独运行时指定applicationId</span></span><br><span class="line">            applicationId rootProject.ext.android.organization + <span class="string">"."</span> + componentName</span><br><span class="line">            multiDexEnabled <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        javaCompileOptions &#123;</span><br><span class="line">            annotationProcessorOptions &#123;</span><br><span class="line"><span class="comment">//                includeCompileClasspath true</span></span><br><span class="line">                arguments = [<span class="string">moduleName:</span> project.getName()]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        versionCode <span class="number">1</span></span><br><span class="line">        versionName <span class="string">"1.0.0"</span></span><br><span class="line">        <span class="comment">// 指定资源的文件的前缀</span></span><br><span class="line">        resourcePrefix componentName + <span class="string">"_"</span></span><br><span class="line">        resValue <span class="string">"string"</span>, componentName + <span class="string">"_module_name"</span>, project.getName()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果独立运行的话，需要指定其独立运行特有的文件夹，这里都放在main下的runalone中（包括java文件和资源文件）</span></span><br><span class="line">    <span class="keyword">if</span> (isRunAlone) &#123;</span><br><span class="line">        sourceSets &#123;</span><br><span class="line">            main &#123;</span><br><span class="line">                <span class="comment">// 指定AndroidManifest.xml文件</span></span><br><span class="line">                manifest.srcFile <span class="string">'src/main/runalone/AndroidManifest.xml'</span></span><br><span class="line">                <span class="comment">// 指定Java源文件</span></span><br><span class="line">                java.srcDirs = [<span class="string">'src/main/java'</span>, <span class="string">'src/main/runalone/java'</span>]</span><br><span class="line">                <span class="comment">// 指定资源文件</span></span><br><span class="line">                res.srcDirs = [<span class="string">'src/main/res'</span>, <span class="string">'src/main/runalone/res'</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="literal">false</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    android &#123;</span><br><span class="line">        lintOptions &#123;</span><br><span class="line">            abortOnError <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置组件项目依赖</span></span><br><span class="line">    dependencies &#123;</span><br><span class="line">        <span class="comment">// 添加对通用库的依赖</span></span><br><span class="line">        api project(<span class="string">":common"</span>)</span><br><span class="line">        <span class="comment">// test</span></span><br><span class="line">        testImplementation rootProject.ext.dependencies[<span class="string">'junit'</span>]</span><br><span class="line">        testImplementation rootProject.ext.dependencies[<span class="string">'junit'</span>]</span><br><span class="line">        testImplementation rootProject.ext.dependencies[<span class="string">'robolectric'</span>]</span><br><span class="line">        testImplementation rootProject.ext.dependencies[<span class="string">'shadows-support'</span>]</span><br><span class="line">        testImplementation rootProject.ext.dependencies[<span class="string">'shadows-multidex'</span>]</span><br><span class="line">        androidTestImplementation rootProject.ext.dependencies[<span class="string">'runner'</span>]</span><br><span class="line">        androidTestImplementation rootProject.ext.dependencies[<span class="string">'espresso'</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>根目录下的配置文件config.gradle内容如下：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">ext &#123;</span><br><span class="line">     <span class="comment">// build.gradle 文件中的android模块对应配置</span></span><br><span class="line">    android = [</span><br><span class="line">            <span class="string">organization     :</span> <span class="string">"$&#123;organization&#125;"</span>,</span><br><span class="line">            <span class="string">applicationId    :</span> <span class="string">"$&#123;organization&#125;"</span>,</span><br><span class="line"><span class="symbol">            buildToolsVersion:</span> <span class="string">"28.0.3"</span>,</span><br><span class="line"><span class="symbol">            compileSdkVersion:</span> <span class="number">28</span>,</span><br><span class="line">            <span class="string">minSdkVersion    :</span> <span class="number">19</span>,</span><br><span class="line">            <span class="string">targetSdkVersion :</span> <span class="number">28</span>,</span><br><span class="line">            <span class="string">versionCode      :</span> <span class="number">1</span>,</span><br><span class="line">            <span class="string">versionName      :</span> <span class="string">"1.0.0"</span></span><br><span class="line">    ]</span><br><span class="line">    <span class="comment">// 要合并到主库的组件，未填写的组件可以独立运行</span></span><br><span class="line">    merge = [</span><br><span class="line"><span class="comment">//            "app",</span></span><br><span class="line"><span class="comment">//            "image",</span></span><br><span class="line"><span class="comment">//            "movie",</span></span><br><span class="line"><span class="comment">//            "music",</span></span><br><span class="line"><span class="comment">//            "video",</span></span><br><span class="line"><span class="comment">//            "read"</span></span><br><span class="line">    ]</span><br><span class="line">    <span class="comment">// 其他配置</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>有了上面的配置后，如果一个组件如image需要集成进App壳子工程中，取消merge数组中image的注释即可，如果单独运行，注释起来即可；</p>
<h3 id="组件通信"><a href="#组件通信" class="headerlink" title="组件通信"></a>组件通信</h3><p>组件通信包括组件间的参数传递，页面跳转，这里将两种实现方式，一种是基于<strong><em>接口+实现</em></strong>的方式来实现的，一种是使用<a href="https://github.com/alibaba/ARouter" target="_blank" rel="noopener">ARouter</a>来实现的。</p>
<h4 id="接口-实现来完成组件通信"><a href="#接口-实现来完成组件通信" class="headerlink" title="接口+实现来完成组件通信"></a>接口+实现来完成组件通信</h4><p>为了演示通过接口+实现来完成组件通信，这里新建两个组件：component-music、component-video，分别对应登录组件和分享组件，以及一个用来实现通信的component-base 库，其实最终依赖的是<strong><em>Java的反射机制</em></strong>。</p>
<h5 id="component-base库"><a href="#component-base库" class="headerlink" title="component-base库"></a>component-base库</h5><p>新建一个类型为Library的component-base的module（名字可以随便取了），改库的职责就是集中处理各个组件需要暴露出来的服务（service），比如music和video要暴露哪些方法给其他组件调用，都可以以接口的形式在这里定义，然后相应的组件中实现这些接口。这里假设music组件和video组件要暴露的服务（即接口）分别为IMusicService和IVideoService，其定义如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IMusicService.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IMusicService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 进入music模块的主界面</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">goMusicMain</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 唤起Video模块播放视频界面播放视频</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> musicUrl 视频地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">playMusic</span><span class="params">(String musicUrl)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// IVideoService.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IVideoService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 进入Video模块的主界面</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">goVideoMain</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 唤起Video模块播放视频界面播放视频</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> videoUrl 视频地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">playVideo</span><span class="params">(String videoUrl)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面的两个定义在<code>component-base</code>这个module中,为了兼容（即避免service没有获取到的情况），我在<code>component-base</code>中提供了连个接口的默认实现（空实现）。内容如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DefaultVideoService.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultVideoService</span> <span class="keyword">implements</span> <span class="title">IVideoService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">goVideoMain</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.d(<span class="string">"VideoService"</span>, <span class="string">"goVideoMain default implementation"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">playVideo</span><span class="params">(String videoUrl)</span> </span>&#123;</span><br><span class="line">        Log.d(<span class="string">"VideoService"</span>, <span class="string">"playVideo default implementation"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// DefaultMusicService</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultMusicService</span> <span class="keyword">implements</span> <span class="title">IMusicService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">goMusicMain</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">playMusic</span><span class="params">(String musicUrl)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面四个文件定义好后，我们就要考虑如何几种管理了，这里我新建了一个ServiceFactory，用来管理各组件暴露给外部的服务。内容如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ServiceFactory.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceFactory</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> IMusicService musicService;</span><br><span class="line">    <span class="keyword">private</span> IVideoService videoService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ServiceFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ServiceFactory <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Inner.serviceFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Inner</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> ServiceFactory serviceFactory = <span class="keyword">new</span> ServiceFactory();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IMusicService <span class="title">getMusicService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (musicService == <span class="keyword">null</span>) &#123;</span><br><span class="line">            musicService = <span class="keyword">new</span> DefaultMusicService();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> musicService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMusicService</span><span class="params">(IMusicService musicService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.musicService = musicService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IVideoService <span class="title">getVideoService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (videoService == <span class="keyword">null</span>) &#123;</span><br><span class="line">            videoService = <span class="keyword">new</span> DefaultVideoService();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> videoService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVideoService</span><span class="params">(IVideoService videoService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.videoService = videoService;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>看下component-base现在的基本结构：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">com.rainmonth.componentbase</span><br><span class="line">├── ServiceFactory.java</span><br><span class="line">└── service</span><br><span class="line">    ├── music                           // music组件的相关服务</span><br><span class="line">    │   ├── DefaultMusicService.java</span><br><span class="line">    │   └── IMusicService.java</span><br><span class="line">    └── video                           // video组件的相关服务</span><br><span class="line">        ├── DefaultVideoService.java</span><br><span class="line">        └── IVideoService.java</span><br></pre></td></tr></table></figure></p>
<p>到此，component-base的基本职责就实现了。</p>
<h5 id="服务的注册"><a href="#服务的注册" class="headerlink" title="服务的注册"></a>服务的注册</h5><p>定义好ServiceFactory后，我们就要想办法把各个component自己实现的service注册到ServiceFactory中，前面提到了各个component都依赖于component-base，所以我们是要在component实现了ServiceFactory中定义好接口，然后调用相应的set方法将其引用传递给ServiceFactory即可。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// component-music下的MusicServie.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MusicService</span> <span class="keyword">implements</span> <span class="title">IMusicService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">goMusicMain</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        KLog.d(<span class="string">"MusicService"</span>, <span class="string">"goMusicMain"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">playMusic</span><span class="params">(String musicUrl)</span> </span>&#123;</span><br><span class="line">        KLog.d(<span class="string">"MusicService"</span>, <span class="string">"playMusic with url-&gt;"</span> + musicUrl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// component-video下的VideoService.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoService</span> <span class="keyword">implements</span> <span class="title">IVideoService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">goVideoMain</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        KLog.d(<span class="string">"VideoService"</span>, <span class="string">"goVideoMain"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">playVideo</span><span class="params">(String videoUrl)</span> </span>&#123;</span><br><span class="line">        KLog.d(<span class="string">"VideoService"</span>, <span class="string">"playVideo with url-&gt;"</span> + videoUrl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// component-music下的MusicApplication.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MusicApplication</span> <span class="keyword">extends</span> <span class="title">BaseApplication</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        ServiceFactory.getInstance().setMusicService(<span class="keyword">new</span> MusicService());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// component-video吓得VideoApplication.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoApplication</span> <span class="keyword">extends</span> <span class="title">BaseApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        ServiceFactory.getInstance().setVideoService(<span class="keyword">new</span> VideoService());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>经过上面一波操作，各个组件的接口服务就已经注册到ServiceFactory中了，只要在需要调用的得房调用ServiceFactory的get方法然后调用即可。如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// music下的随便一个Activity</span><br><span class="line">tvTest.setOnClickListener(new View.OnClickListener() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void onClick(View v) &#123;</span><br><span class="line">                ServiceFactory.getInstance().getVideoService().playVideo(&quot;https://www.baidu.com/test.mp4&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure></p>
<h5 id="组件Application动态配置问题解决"><a href="#组件Application动态配置问题解决" class="headerlink" title="组件Application动态配置问题解决"></a>组件Application动态配置问题解决</h5><p>上面接口服务的注册放在了各个module的Application创建时，但当组件作为子module被主module所依赖是，由于Application的替换原则，组件的Application根本不会被创建，因为就不能注册进去了。当然我们可以在主module的Application中（这里就叫MainApplication)持有各个子module的Application的强引用，然后在调用相关的方法完成注册，但这就耦合起来了。可以采用反射机制来避免强引用。具体操作如下：</p>
<ol>
<li><p>在BaseApplication中定义一个抽象方法，用来供module实现（包括主module和子module）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//BaseApplication.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BaseApplicationDelegate mBaseApplicationDelegate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这是个模板方法，库module只负责实现，真正的调用发生在主module中</span></span><br><span class="line"><span class="comment">     * 初始化module对外提供的服务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">initModuleService</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>所有的组件module都继承BaseApplication，并实现其定义的方法，同时将服务注册给自己，方便独立运行时使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MusicApplication.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MusicApplication</span> <span class="keyword">extends</span> <span class="title">BaseApplication</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        initModuleService();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initModuleService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ServiceFactory.getInstance().setMusicService(<span class="keyword">new</span> MusicService());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// VideoApplication.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoApplication</span> <span class="keyword">extends</span> <span class="title">BaseApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        initModuleService();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initModuleService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ServiceFactory.getInstance().setVideoService(<span class="keyword">new</span> VideoService());</span><br></pre></td></tr></table></figure>
</li>
<li><p>集中各个module的Application类，以方便遍历反射。这里采用在common库中定义一个ServiceConfig类，内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String videoApp = <span class="string">"com.rainmonth.video.config.VideoApplication"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String musicApp = <span class="string">"com.rainmonth.music.config.MusicApplication"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] appModules = &#123;</span><br><span class="line">            videoApp,</span><br><span class="line">            musicApp</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>后面如果其他组件有类似服务，只要将其所属的Application的类路径加入到appMoudles数组即可。</p>
<ol>
<li>主Module中继承BaseApplication，实现并调用BaseApplication的中的抽象方法，内容如下：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MainApplication.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> <span class="keyword">extends</span> <span class="title">BaseApplication</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        <span class="comment">// 调用方法，通过反射完成各个module下的接口服务注册</span></span><br><span class="line">        initModuleService();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initModuleService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (String moduleApp : ServiceConfig.appModules) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class clazz = Class.forName(moduleApp);</span><br><span class="line">                BaseApplication baseApp = (BaseApplication) clazz.newInstance();</span><br><span class="line">                baseApp.initModuleService();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>至此，我们就通过接口+实现的方式解决了组件通信的问题了。</p>
<h4 id="ARouter完成组件通信"><a href="#ARouter完成组件通信" class="headerlink" title="ARouter完成组件通信"></a>ARouter完成组件通信</h4><p>关于使用ARouter来完成组件间的通信，可以参看<a href="https://rainmonth.github.io/posts/A191110" target="_blank" rel="noopener">Android ARouter使用及源码分析</a>一文来具体了解。<br>这里就简单介绍下其使用。</p>
<h5 id="添加注解"><a href="#添加注解" class="headerlink" title="添加注解"></a>添加注解</h5><p>假设APP壳子中有一个需要调整到component-music下的MusicMainActivity，那么我们需要按如下方式添加注解：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 音乐主页面</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Route</span>(path = RouterConstant.PATH_MUSIC_HOME)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MusicMainActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的path是RouterConstant下定义的PATH_MUSIC_HOME常量，其值为<code>/music/home</code>要求至少要有两级，一个表示group，一个表示具体的页面。这里建议将所有的ARouter要使用的PATH值几种设置在route这个module下，方便管理。</p>
<h5 id="使用注解"><a href="#使用注解" class="headerlink" title="使用注解"></a>使用注解</h5><p>上面的注解添加完成后，可以调用在要进行通信的地方按如下方式调用：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RouterUtils.getInstance().build(RouterConstant.PATH_MUSIC_HOME).navigation();</span><br></pre></td></tr></table></figure></p>
<p>上面的RouterUtils为ARouter的简单封装，内容如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rainmonth.router;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.launcher.ARouter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 路由工具类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouterUtils</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ARouter <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ARouter.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样就可以完成组件间的页面跳转了，当然在上面调用navigation时可以传递参数，这里就不详述了。</p>
<h3 id="组件集成"><a href="#组件集成" class="headerlink" title="组件集成"></a>组件集成</h3><p>组件集成很简单，将想要集成的组件名字（去掉component-前缀）加入到config.gradle的merge数组中即可将其集成到App module中。</p>
<h3 id="组件容错"><a href="#组件容错" class="headerlink" title="组件容错"></a>组件容错</h3><p>上面的实例中已经提到了，可以在服务获取不要是提供一个空实现，或者给与提示，这样就可以避免由于找不到服务而导致App crash。</p>
<h3 id="组件解耦"><a href="#组件解耦" class="headerlink" title="组件解耦"></a>组件解耦</h3><p>这里说的解耦指的是主module在不直接访问组件类的情况下使用组件提供的服务，看到上面的接口+实现方法解决通信问题后，很资源的就想到可以用反射来解决这个问题，原理类似，这里就不再赘述了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上就是我组件化的一个实践，主要涉及到了一些gradle的基本配置、反射解耦及接口+实现的方式解决通信问题，其实组件化并没有那么复杂。</p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/posts/A191025.html" rel="next" title="Android Service详解">
                <i class="fa fa-chevron-left"></i> Android Service详解
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/posts/A191101.html" rel="prev" title="Android ExoPlayer使用与分析">
                Android ExoPlayer使用与分析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Randy Zhang</p>
              <p class="site-description motion-element" itemprop="description">记录学习Android、前端开发以及Python的点点滴滴</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">78</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">37</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/Rainmonth" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#摘要"><span class="nav-number">1.</span> <span class="nav-text">摘要</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#结构"><span class="nav-number">2.</span> <span class="nav-text">结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#要解决的问题"><span class="nav-number">3.</span> <span class="nav-text">要解决的问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#组件单独调试"><span class="nav-number">3.1.</span> <span class="nav-text">组件单独调试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#组件通信"><span class="nav-number">3.2.</span> <span class="nav-text">组件通信</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#接口-实现来完成组件通信"><span class="nav-number">3.2.1.</span> <span class="nav-text">接口+实现来完成组件通信</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#component-base库"><span class="nav-number">3.2.1.1.</span> <span class="nav-text">component-base库</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#服务的注册"><span class="nav-number">3.2.1.2.</span> <span class="nav-text">服务的注册</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#组件Application动态配置问题解决"><span class="nav-number">3.2.1.3.</span> <span class="nav-text">组件Application动态配置问题解决</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ARouter完成组件通信"><span class="nav-number">3.2.2.</span> <span class="nav-text">ARouter完成组件通信</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#添加注解"><span class="nav-number">3.2.2.1.</span> <span class="nav-text">添加注解</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#使用注解"><span class="nav-number">3.2.2.2.</span> <span class="nav-text">使用注解</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#组件集成"><span class="nav-number">3.3.</span> <span class="nav-text">组件集成</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#组件容错"><span class="nav-number">3.4.</span> <span class="nav-text">组件容错</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#组件解耦"><span class="nav-number">3.5.</span> <span class="nav-text">组件解耦</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate"> 
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Randy Zhang</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Gemini</a> v6.1.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.1.0"></script>



  



	





  





  










  





  

  

  

  
  

  
  

  


  
  

  

  

  

  

</body>
</html>
